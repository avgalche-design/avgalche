// app/products/page.jsx
import { shopifyFetch } from "../../lib/shopify";
import ProductGridClient from "./components/ProductGridClient";

const PRODUCTS_QUERY = `
{
  products(first: 30) {
    edges {
      node {
        id
        title
        handle
        description
        productType
        images(first: 5) {
          edges {
            node {
              url
              altText
            }
          }
        }
        variants(first: 1) {
          edges {
            node {
              priceV2 {
                amount
                currencyCode
              }
            }
          }
        }
      }
    }
  }
}
`;

export default async function ProductsPage() {
  const data = await shopifyFetch({ query: PRODUCTS_QUERY });

  // Defensive mapping: build a simple, serializable product shape
  const products =
    data?.products?.edges?.map((edge) => {
      const node = edge?.node ?? {};
      return {
        id: node.id ?? "",
        title: node.title ?? "Untitled",
        handle: node.handle ?? "",
        description: node.description ?? "",
        category: node.productType ?? "Uncategorized",
        images:
          node.images?.edges?.map((ie) => ({
            url: ie?.node?.url ?? null,
            altText: ie?.node?.altText ?? "",
          })) ?? [],
        variants:
          node.variants?.edges?.map((ve) => ({
            price:
              ve?.node?.priceV2?.amount != null
                ? {
                    amount: ve.node.priceV2.amount,
                    currencyCode: ve.node.priceV2.currencyCode,
                  }
                : null,
          })) ?? [],
      };
    }) ?? [];

  return (
    <>
      {/* Luxury Loading Animation */}
      <div
        className="fixed inset-0 bg-black z-50 flex items-center justify-center opacity-0 pointer-events-none transition-opacity duration-1000"
        id="luxury-loader"
      >
        <div className="relative">
          <div className="w-16 h-16 border-2 border-gray-800 rounded-full animate-spin">
            <div className="absolute top-0 left-0 w-4 h-4 bg-gradient-to-r from-amber-400 to-amber-600 rounded-full"></div>
          </div>
          <p className="text-white text-sm tracking-[0.3em] mt-6 text-center">
            AV GALCHE
          </p>
        </div>
      </div>

      <main className="bg-black min-h-screen text-white relative overflow-hidden">
        {/* Ambient Background Elements */}
        <div className="fixed inset-0 opacity-5">
          <div className="absolute top-20 left-10 w-96 h-96 bg-gradient-to-br from-amber-400/20 to-transparent rounded-full blur-3xl animate-pulse"></div>
          <div
            className="absolute bottom-20 right-10 w-80 h-80 bg-gradient-to-br from-gray-400/10 to-transparent rounded-full blur-3xl animate-pulse"
            style={{ animationDelay: "2s" }}
          ></div>
        </div>

        {/* Hero Section with Cinematic Intro */}
        <section className="relative min-h-screen flex items-center justify-center">
          {/* Geometric Pattern Overlay */}
          <div className="absolute inset-0 opacity-10">
            <div className="absolute top-1/4 left-1/4 w-1 h-32 bg-gradient-to-b from-amber-400 to-transparent transform rotate-45"></div>
            <div className="absolute top-1/3 right-1/4 w-1 h-24 bg-gradient-to-b from-gray-400 to-transparent transform -rotate-45"></div>
            <div className="absolute bottom-1/4 left-1/3 w-1 h-28 bg-gradient-to-b from-amber-400 to-transparent transform rotate-12"></div>
          </div>

          <div className="max-w-4xl mx-auto text-center px-8 relative z-10">
            {/* Season Tag */}
            <div className="inline-block mb-8 relative">
              <div className="absolute inset-0 bg-gradient-to-r from-amber-400/20 to-amber-600/20 rounded-full blur-md"></div>
              <p className="relative text-xs text-amber-400 tracking-[0.4em] uppercase font-light px-6 py-2 border border-amber-400/30 rounded-full backdrop-blur-sm">
                Winter Collection 2025-2026
              </p>
            </div>

            {/* Brand Name with Luxury Typography */}
            <h1 className="text-6xl md:text-8xl lg:text-9xl font-extralight tracking-[-0.02em] mb-8 relative">
              <span className="bg-gradient-to-b from-white via-gray-100 to-gray-300 bg-clip-text text-transparent">
                AV
              </span>
              <span className="text-amber-400 mx-4 font-serif italic">×</span>
              <span className="bg-gradient-to-b from-white via-gray-100 to-gray-300 bg-clip-text text-transparent">
                GaLche
              </span>

              {/* Subtle underline */}
              <div className="absolute bottom-0 left-1/2 transform -translate-x-1/2 w-32 h-px bg-gradient-to-r from-transparent via-amber-400 to-transparent"></div>
            </h1>

            {/* Poetic Description */}
            <div className="max-w-2xl mx-auto mb-12">
              <p className="text-lg md:text-xl text-gray-300 leading-relaxed font-light mb-6">
                Between <em>heritage</em> and <em>modernity</em>, the AV GaLche
                capsule collection reveals an iconic signature inspired by
                timeless artistry
              </p>
              <p className="text-sm text-gray-400 leading-relaxed max-w-lg mx-auto">
                Each piece embodies the essence of contemporary luxury, where
                meticulous craftsmanship meets avant-garde design philosophy
              </p>
            </div>

            {/* Collection Stats */}
            <div className="flex justify-center items-center space-x-12 text-sm">
              <div className="text-center">
                <p className="text-2xl font-light text-amber-400 mb-1">
                  {products.length}
                </p>
                <p className="text-gray-400 uppercase tracking-widest text-xs">
                  Pieces
                </p>
              </div>
              <div className="w-px h-8 bg-gray-700"></div>
              <div className="text-center">
                <p className="text-2xl font-light text-amber-400 mb-1">∞</p>
                <p className="text-gray-400 uppercase tracking-widest text-xs">
                  Possibilities
                </p>
              </div>
              <div className="w-px h-8 bg-gray-700"></div>
              <div className="text-center">
                <p className="text-2xl font-light text-amber-400 mb-1">2025</p>
                <p className="text-gray-400 uppercase tracking-widest text-xs">
                  Edition
                </p>
              </div>
            </div>

            {/* Scroll Indicator */}
            <div className="absolute bottom-12 left-1/2 transform -translate-x-1/2 animate-bounce">
              <div className="w-6 h-10 border border-gray-600 rounded-full flex justify-center">
                <div className="w-1 h-3 bg-amber-400 rounded-full mt-2 animate-pulse"></div>
              </div>
              <p className="text-xs text-gray-500 tracking-widest mt-2">
                SCROLL
              </p>
            </div>
          </div>
        </section>

        {/* Products Section */}
        <section className="relative z-10 px-4 sm:px-8 lg:px-12 pb-24">
          {/* Section Header */}
          <div className="max-w-7xl mx-auto mb-16">
            <div className="flex items-center justify-between mb-8">
              <div>
                <h2 className="text-3xl md:text-4xl font-light tracking-wide mb-2">
                  The Collection
                </h2>
                <p className="text-gray-400 text-sm tracking-wide">
                  Curated excellence in every detail
                </p>
              </div>

              {/* Filter/Sort Controls */}
              <div className="hidden md:flex items-center space-x-6">
                <button className="text-sm text-gray-400 hover:text-white transition-colors duration-300 uppercase tracking-wider border-b border-transparent hover:border-amber-400 pb-1">
                  All
                </button>
                <button className="text-sm text-gray-400 hover:text-white transition-colors duration-300 uppercase tracking-wider border-b border-transparent hover:border-amber-400 pb-1">
                  New
                </button>
                <button className="text-sm text-gray-400 hover:text-white transition-colors duration-300 uppercase tracking-wider border-b border-transparent hover:border-amber-400 pb-1">
                  Featured
                </button>
              </div>
            </div>

            {/* Decorative Line */}
            <div className="w-full h-px bg-gradient-to-r from-transparent via-gray-800 to-transparent"></div>
          </div>

          {/* Enhanced Product Grid */}
          <div className="max-w-7xl mx-auto">
            <ProductGridClient products={products} />
          </div>
        </section>

        {/* Luxury Footer Section */}
        <section className="relative z-10 border-t border-gray-800 pt-16 pb-12 px-4 sm:px-8 lg:px-12">
          <div className="max-w-7xl mx-auto">
            <div className="grid grid-cols-1 md:grid-cols-3 gap-12 mb-12">
              {/* Brand Philosophy */}
              <div>
                <h3 className="text-lg font-light mb-4 tracking-wide">
                  Philosophy
                </h3>
                <p className="text-sm text-gray-400 leading-relaxed">
                  AV GaLche represents the intersection of art and fashion,
                  where each creation tells a story of uncompromising quality
                  and timeless elegance.
                </p>
              </div>

              {/* Craftsmanship */}
              <div>
                <h3 className="text-lg font-light mb-4 tracking-wide">
                  Craftsmanship
                </h3>
                <p className="text-sm text-gray-400 leading-relaxed">
                  Every piece is meticulously crafted by master artisans,
                  ensuring that tradition and innovation converge in perfect
                  harmony.
                </p>
              </div>

              {/* Heritage */}
              <div>
                <h3 className="text-lg font-light mb-4 tracking-wide">
                  Heritage
                </h3>
                <p className="text-sm text-gray-400 leading-relaxed">
                  Rooted in centuries of textile excellence, we continue to push
                  boundaries while honoring the timeless principles of haute
                  couture.
                </p>
              </div>
            </div>

            {/* Final Brand Mark */}
            <div className="text-center pt-8 border-t border-gray-900">
              <div className="inline-block">
                <p className="text-2xl font-extralight tracking-[0.3em] text-gray-300 mb-2">
                  AV × GaLche
                </p>
                <div className="w-24 h-px bg-gradient-to-r from-transparent via-amber-400 to-transparent mx-auto"></div>
              </div>
            </div>
          </div>
        </section>
      </main>

      {/* JavaScript for Luxury Loading Effect */}
      <script
        dangerouslySetInnerHTML={{
          __html: `
          window.addEventListener('load', function() {
            const loader = document.getElementById('luxury-loader');
            setTimeout(() => {
              loader.style.opacity = '0';
              setTimeout(() => {
                loader.style.display = 'none';
              }, 1000);
            }, 2000);
          });

          // Smooth scroll behavior for luxury experience
          document.addEventListener('DOMContentLoaded', function() {
            const scrollLinks = document.querySelectorAll('a[href^="#"]');
            scrollLinks.forEach(link => {
              link.addEventListener('click', function(e) {
                e.preventDefault();
                const target = document.querySelector(this.getAttribute('href'));
                if (target) {
                  target.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
              });
            });
          });

          // Parallax effect for luxury elements
          window.addEventListener('scroll', function() {
            const scrolled = window.pageYOffset;
            const parallaxElements = document.querySelectorAll('[data-parallax]');
            parallaxElements.forEach(el => {
              const speed = parseFloat(el.dataset.parallax) || 0.5;
              el.style.transform = \`translateY(\${scrolled * speed}px)\`;
            });
          });
        `,
        }}
      />
    </>
  );
}
